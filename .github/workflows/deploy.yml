name: Deploy to Production

on:
  push:
    branches:
      - production 

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        id: checkout
        continue-on-error: true
        uses: actions/checkout@v4

      - name: Log Checkout Status
        if: always()
        run: |
          if [ "${{ steps.checkout.outcome }}" == "success" ]; then
            echo "‚úÖ Checkout successful"
          else
            echo "‚ùå Checkout failed"
            exit 1
          fi

      - name: Set Up SSH Key
        id: ssh-setup
        continue-on-error: true
        run: |
          mkdir -p ~/.ssh || exit 1
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519 || exit 1
          chmod 600 ~/.ssh/id_ed25519 || exit 1
          ssh-keyscan -H hackclub.app >> ~/.ssh/known_hosts || exit 1

      - name: Log SSH Setup Status
        if: always()
        run: |
          if [ "${{ steps.ssh-setup.outcome }}" == "success" ]; then
            echo "‚úÖ SSH setup successful"
          else
            echo "‚ùå SSH setup failed"
            exit 1
          fi

      - name: Deploy Code to Server
        id: deploy
        continue-on-error: true
        run: |
          if ! ssh boo@hackclub.app << 'EOF'
            set -e
            echo "üìÇ Changing directory..."
            cd /home/boo/pub 
            echo "üîÑ Pulling latest changes..."
            git pull origin production
            echo "üîÑ Reloading Caddy..."
            ./reloadCaddy.sh
          EOF
          then
            echo "‚ùå Deployment failed"
            exit 1
          fi

      - name: Log Deployment Status
        if: always()
        run: |
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "‚úÖ Deployment successful"
          else
            echo "‚ùå Deployment failed"
            exit 1
          fi

      - name: Notify Deployment Status
        if: always()
        run: |
          echo "Deployment Summary:"
          echo "Checkout: ${{ steps.checkout.outcome }}"
          echo "SSH Setup: ${{ steps.ssh-setup.outcome }}"
          echo "Deploy: ${{ steps.deploy.outcome }}"